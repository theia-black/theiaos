<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THEIA â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEIA WAR ROOM â€” Chromatic Aberration Glass + Particle Field
   Jony Ive designing for Hades
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --void: #050507;
  --panel-bg: rgba(0,0,0,0.1);
  --border-color: rgba(255,255,255,0.04);
  --border-hover: rgba(255,255,255,0.08);
  --text-primary: rgba(255,255,255,0.9);
  --text-secondary: rgba(255,255,255,0.45);
  --text-tertiary: rgba(255,255,255,0.25);
  --crimson: #C3131D;
  --crimson-glow: rgba(195,19,29,0.3);
  --crimson-dim: rgba(195,19,29,0.08);
  --green: #00ff41;
  --green-glow: rgba(0,255,65,0.3);
  --amber: #ffaa00;
  --amber-glow: rgba(255,170,0,0.3);
  --red: #ff3333;
  --red-glow: rgba(255,51,51,0.3);
  --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
  --radius: 20px;
  --radius-sm: 12px;
}

html, body {
  height: 100%; overflow: hidden;
  background: var(--void); color: var(--text-primary);
  font-family: var(--font-main); font-size: 14px; line-height: 1.5;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
}

/* â”€â”€ WebGL Background Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#bg-canvas {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0; pointer-events: none;
}

/* â”€â”€ Particle Overlay Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#particle-canvas {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 1; pointer-events: none;
}

/* â”€â”€ Film Grain Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.film-grain {
  position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
  z-index: 2; pointer-events: none; opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  animation: grain 0.5s steps(1) infinite;
}
@keyframes grain {
  0% { transform: translate(0,0); }
  25% { transform: translate(-5%,-5%); }
  50% { transform: translate(5%,3%); }
  75% { transform: translate(-3%,5%); }
  100% { transform: translate(3%,-3%); }
}

/* â”€â”€ SVG Filters (hidden) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.svg-filters { position: absolute; width: 0; height: 0; overflow: hidden; }

/* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app {
  position: relative; z-index: 3;
  display: flex; flex-direction: column;
  height: 100vh; overflow: hidden;
}

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes liquidFloat {
  0%, 100% { transform: translate3d(0, 0, 0); }
  33% { transform: translate3d(0, -4px, 0); }
  66% { transform: translate3d(0, 2px, 0); }
}
@keyframes liquidBreathe {
  0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
  50% { transform: scale(1.01) rotate(0.3deg); opacity: 0.95; }
}
@keyframes liquidPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.02); opacity: 0.9; }
}
@keyframes liquidGlow {
  0%, 100% { box-shadow: 0 0 20px rgba(195,19,29,0.05); }
  50% { box-shadow: 0 0 40px rgba(195,19,29,0.12); }
}
@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* â”€â”€ GPU acceleration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gpu-accel {
  transform: translate3d(0,0,0);
  backface-visibility: hidden;
  will-change: transform;
}

/* â”€â”€ Glass Panel (Chromatic Aberration) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.glass {
  position: relative;
  background: transparent;
  border-radius: var(--radius);
  box-shadow:
    0 0 2px 1px color-mix(in oklch, white, transparent 65%) inset,
    0 0 10px 4px color-mix(in oklch, white, transparent 85%) inset,
    0px 4px 16px rgba(17, 17, 26, 0.05),
    0px 8px 24px rgba(17, 17, 26, 0.05),
    0px 16px 56px rgba(17, 17, 26, 0.05),
    0px 4px 16px rgba(17, 17, 26, 0.05) inset,
    0px 8px 24px rgba(17, 17, 26, 0.05) inset,
    0px 16px 56px rgba(17, 17, 26, 0.05) inset;
  display: flex; flex-direction: column;
  min-height: 0; overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  animation: liquidFloat 6s ease-in-out infinite, liquidGlow 3s ease-in-out infinite;
}
.glass:hover {
  transform: translateY(-2px);
  box-shadow:
    0 0 2px 1px color-mix(in oklch, white, transparent 55%) inset,
    0 0 12px 5px color-mix(in oklch, white, transparent 80%) inset,
    0px 6px 20px rgba(17, 17, 26, 0.08),
    0px 12px 32px rgba(17, 17, 26, 0.08),
    0px 20px 64px rgba(17, 17, 26, 0.08),
    0px 6px 20px rgba(17, 17, 26, 0.08) inset,
    0px 12px 32px rgba(17, 17, 26, 0.08) inset,
    0px 20px 64px rgba(17, 17, 26, 0.08) inset;
}

/* Chromatic aberration overlay â€” applied via SVG filter */
.glass-ca-overlay {
  position: absolute; inset: 0;
  border-radius: inherit;
  pointer-events: none;
  z-index: 0;
  opacity: 0.85;
}

/* Specular highlight */
.glass::before {
  content: "";
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  border-radius: inherit;
  background: linear-gradient(145deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 40%, transparent 100%);
  pointer-events: none; z-index: 1;
}

/* Cursor-tracking light spot */
.glass-light {
  position: absolute; width: 200px; height: 200px;
  border-radius: 50%; pointer-events: none;
  background: radial-gradient(circle, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.04) 40%, transparent 70%);
  filter: blur(15px);
  transform: translate(-50%, -50%);
  opacity: 0; transition: opacity 0.3s ease;
  z-index: 2; mix-blend-mode: overlay;
}
.glass:hover .glass-light { opacity: 1; }

.glass-header {
  padding: 16px 20px; flex-shrink: 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  display: flex; align-items: center; justify-content: space-between;
  position: relative; z-index: 5;
}
.glass-title {
  font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--text-secondary); font-weight: 500;
}
.glass-badge {
  font-size: 10px; font-family: var(--font-mono);
  padding: 2px 10px; border-radius: 8px;
  background: rgba(255,255,255,0.04);
  color: var(--text-secondary);
}
.glass-body {
  flex: 1; overflow-y: auto; padding: 12px 16px; min-height: 0;
  position: relative; z-index: 5;
}
.glass-body::-webkit-scrollbar { width: 3px; }
.glass-body::-webkit-scrollbar-track { background: transparent; }
.glass-body::-webkit-scrollbar-thumb {
  background: rgba(195,19,29,0.25); border-radius: 3px;
}

/* â”€â”€ Shared Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 28px; flex-shrink: 0;
  background: rgba(5,5,7,0.5);
  backdrop-filter: blur(24px) saturate(150%);
  -webkit-backdrop-filter: blur(24px) saturate(150%);
  border-bottom: 1px solid rgba(255,255,255,0.03);
  position: relative; z-index: 10;
}
.nav-bar::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent 5%, var(--crimson-glow) 50%, transparent 95%);
}
.nav-brand { display: flex; flex-direction: column; gap: 2px; }
.nav-brand-name {
  font-size: 13px; font-weight: 300; letter-spacing: 0.3em;
  text-transform: uppercase; color: var(--text-primary);
}
.nav-brand-page {
  font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--crimson); font-weight: 400;
}
.nav-brand-line {
  width: 0; height: 1px; background: var(--crimson);
  box-shadow: 0 0 8px var(--crimson-glow), 0 0 20px rgba(195,19,29,0.15);
  margin-top: 4px;
}
.nav-tabs {
  display: flex; gap: 4px;
  background: rgba(255,255,255,0.02);
  border-radius: 14px; padding: 4px;
  border: 1px solid rgba(255,255,255,0.04);
  backdrop-filter: blur(12px);
}
.nav-tab {
  padding: 7px 18px; border-radius: 10px; font-size: 11px;
  letter-spacing: 0.06em; text-transform: uppercase; font-weight: 500;
  color: var(--text-secondary); text-decoration: none;
  transition: all 0.3s ease;
}
.nav-tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.04); }
.nav-tab.active {
  color: var(--text-primary); background: rgba(195,19,29,0.1);
  box-shadow: 0 0 16px rgba(195,19,29,0.08);
}
.nav-meta { display: flex; align-items: center; gap: 16px; }
.nav-clock {
  color: var(--text-secondary); font-family: var(--font-mono);
  font-size: 11px; letter-spacing: 0.04em; font-weight: 300;
}
.nav-conn {
  display: flex; align-items: center; gap: 6px; font-size: 11px;
  letter-spacing: 0.06em; text-transform: uppercase;
  color: var(--text-secondary); font-weight: 400;
}
.conn-dot {
  width: 6px; height: 6px; border-radius: 50%;
  transition: all 0.3s ease;
}
.conn-dot.ok {
  background: var(--green);
  box-shadow: 0 0 8px var(--green-glow), 0 0 20px rgba(0,255,65,0.15);
  animation: breathe 3s ease-in-out infinite;
}
.conn-dot.err { background: var(--red); box-shadow: 0 0 8px var(--red-glow); }

/* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.war-main {
  flex: 1; display: grid;
  grid-template-columns: 280px 1fr 300px;
  gap: 16px; padding: 16px;
  min-height: 0;
}

/* â”€â”€ Left: Field Agents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.svc-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; border-radius: var(--radius-sm);
  cursor: pointer; transition: all 0.25s ease;
  margin-bottom: 2px;
}
.svc-item:hover {
  background: rgba(255,255,255,0.03);
  transform: translateY(-1px);
}
.svc-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
  transition: all 0.3s ease;
}
.svc-dot.online {
  background: var(--green); box-shadow: 0 0 8px var(--green-glow);
  animation: breathe 3s ease-in-out infinite;
}
.svc-dot.errored, .svc-dot.error {
  background: var(--red); box-shadow: 0 0 10px var(--red-glow);
  animation: breathe 1s ease-in-out infinite;
}
.svc-dot.stopped, .svc-dot.stopping, .svc-dot.unknown {
  background: rgba(255,255,255,0.12);
}
.svc-dot.launching {
  background: var(--amber); box-shadow: 0 0 8px var(--amber-glow);
}
.svc-name {
  flex: 1; font-size: 13px; font-weight: 400;
  color: var(--text-primary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.svc-meta { text-align: right; flex-shrink: 0; }
.svc-meta-line {
  font-size: 10px; font-family: var(--font-mono);
  color: var(--text-secondary); display: block; line-height: 1.4;
  font-weight: 300;
}

/* â”€â”€ Center: Live Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feed-msg {
  display: flex; gap: 8px; padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.02);
  font-size: 13px; animation: fadeSlideIn 0.3s ease;
}
.feed-time {
  font-family: var(--font-mono); font-size: 10px;
  color: var(--text-tertiary); flex-shrink: 0;
  min-width: 56px; padding-top: 2px; font-weight: 300;
}
.feed-icon { flex-shrink: 0; font-size: 12px; padding-top: 1px; }
.feed-speaker { font-weight: 500; flex-shrink: 0; font-size: 13px; }
.feed-speaker.henry { color: var(--text-primary); }
.feed-speaker.theia { color: var(--crimson); }
.feed-speaker.other { color: var(--text-secondary); }
.feed-text {
  color: rgba(255,255,255,0.55); word-break: break-word;
  font-size: 13px; line-height: 1.45; font-weight: 300;
}
.feed-empty {
  display: flex; align-items: center; justify-content: center;
  height: 100%; color: var(--text-tertiary); font-size: 12px;
  letter-spacing: 0.06em; font-weight: 300;
}

/* â”€â”€ Right: Neural / System Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stat-section { margin-bottom: 20px; }
.stat-section-title {
  font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--crimson); font-weight: 500; margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid rgba(195,19,29,0.08);
}
.stat-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 3px 0;
}
.stat-label {
  font-size: 11px; color: var(--text-secondary);
  letter-spacing: 0.02em; font-weight: 400;
}
.stat-value {
  font-size: 11px; font-family: var(--font-mono);
  color: var(--text-primary); font-weight: 400;
}
.stat-value.ok { color: var(--green); text-shadow: 0 0 8px var(--green-glow); }
.stat-value.warn { color: var(--amber); text-shadow: 0 0 8px var(--amber-glow); }
.stat-value.crit { color: var(--red); text-shadow: 0 0 8px var(--red-glow); }

/* â”€â”€ Progress Bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-wrap {
  width: 56px; height: 3px; border-radius: 3px;
  background: rgba(255,255,255,0.04); overflow: hidden;
  display: inline-block; vertical-align: middle; margin-left: 8px;
}
.progress-fill {
  height: 100%; border-radius: 3px;
  transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.progress-fill.ok { background: var(--green); box-shadow: 0 0 6px var(--green-glow); }
.progress-fill.warn { background: var(--amber); box-shadow: 0 0 6px var(--amber-glow); }
.progress-fill.crit { background: var(--red); box-shadow: 0 0 6px var(--red-glow); }

/* â”€â”€ Bottom Command Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cmd-bar {
  padding: 14px 28px; flex-shrink: 0;
  display: flex; align-items: center; gap: 14px;
  background: rgba(5,5,7,0.5);
  backdrop-filter: blur(24px) saturate(150%);
  -webkit-backdrop-filter: blur(24px) saturate(150%);
  border-top: 1px solid rgba(255,255,255,0.03);
  position: relative;
}
.cmd-bar::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent 10%, rgba(195,19,29,0.1) 50%, transparent 90%);
}
.cmd-prompt {
  font-family: var(--font-mono); font-size: 15px;
  color: var(--crimson); flex-shrink: 0; font-weight: 300;
  text-shadow: 0 0 10px var(--crimson-glow);
}
.cmd-input {
  flex: 1; background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: var(--radius-sm); color: var(--text-primary);
  font-family: var(--font-main); font-size: 13px; font-weight: 300;
  padding: 10px 16px; outline: none;
  transition: all 0.3s ease;
}
.cmd-input::placeholder { color: var(--text-tertiary); }
.cmd-input:focus {
  border-color: rgba(195,19,29,0.25);
  box-shadow: 0 0 20px rgba(195,19,29,0.08), 0 0 40px rgba(195,19,29,0.04);
  background: rgba(255,255,255,0.03);
}
.cmd-send {
  background: rgba(195,19,29,0.08); border: 1px solid rgba(195,19,29,0.15);
  color: var(--crimson); padding: 10px 22px; border-radius: var(--radius-sm);
  font-family: var(--font-main); font-size: 11px; font-weight: 500;
  letter-spacing: 0.08em; text-transform: uppercase;
  cursor: pointer; transition: all 0.25s ease;
}
.cmd-send:hover {
  background: rgba(195,19,29,0.15);
  box-shadow: 0 0 20px rgba(195,19,29,0.12);
}
.cmd-chain {
  font-size: 10px; color: var(--text-tertiary); white-space: nowrap;
  letter-spacing: 0.03em; font-weight: 300;
}
.cmd-chain b { color: var(--amber); font-weight: 500; }

/* â”€â”€ Watermark â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.watermark {
  position: fixed; bottom: 10px; right: 24px;
  font-size: 10px; color: rgba(255,255,255,0.06);
  letter-spacing: 0.12em; z-index: 4; pointer-events: none;
  font-weight: 300;
}

/* â”€â”€ Log Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(5,5,7,0.85); backdrop-filter: blur(12px);
  z-index: 100; justify-content: center; align-items: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  width: 75%; max-width: 900px; height: 70%;
  background: rgba(10,10,14,0.9);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: var(--radius);
  box-shadow:
    0 0 2px 1px color-mix(in oklch, white, transparent 65%) inset,
    0 0 10px 4px color-mix(in oklch, white, transparent 85%) inset,
    0px 8px 60px rgba(0,0,0,0.5);
  display: flex; flex-direction: column; overflow: hidden;
}
.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04);
}
.modal-title {
  font-size: 12px; font-weight: 500; letter-spacing: 0.06em;
  color: var(--text-primary); text-transform: uppercase;
}
.modal-close {
  background: none; border: 1px solid rgba(255,255,255,0.06);
  color: var(--text-secondary); border-radius: 8px;
  padding: 5px 14px; font-size: 11px; cursor: pointer;
  font-family: var(--font-main); transition: all 0.2s ease;
}
.modal-close:hover { border-color: var(--crimson); color: var(--crimson); }
.modal-body {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  font-family: var(--font-mono); font-size: 11px;
  color: var(--text-secondary); white-space: pre-wrap; line-height: 1.6;
  font-weight: 300;
}
.modal-body::-webkit-scrollbar { width: 3px; }
.modal-body::-webkit-scrollbar-thumb { background: rgba(195,19,29,0.25); border-radius: 3px; }
</style>
</head>
<body>

<!-- â”€â”€ SVG Chromatic Aberration Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<svg class="svg-filters" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <!-- Filters are generated dynamically per-panel by JS -->
  </defs>
</svg>

<canvas id="bg-canvas"></canvas>
<canvas id="particle-canvas"></canvas>
<div class="film-grain"></div>

<div id="app">
  <!-- â”€â”€ NAV BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <nav class="nav-bar">
    <div class="nav-brand">
      <div class="nav-brand-name">THEIA</div>
      <div class="nav-brand-page">Dashboard</div>
      <div class="nav-brand-line" id="brand-line"></div>
    </div>
    <div class="nav-tabs">
      <a href="/dashboard/" class="nav-tab active">Dashboard</a>
      <a href="/dashboard/mission-control" class="nav-tab">Mission Control</a>
      <a href="/dashboard/fry-room" class="nav-tab">Fry Room</a>
    </div>
    <div class="nav-meta">
      <span class="nav-clock" id="clock">00:00:00 UTC</span>
      <div class="nav-conn" id="conn-status">
        <span class="conn-dot err" id="conn-dot"></span>
        <span id="conn-label">Offline</span>
      </div>
    </div>
  </nav>

  <!-- â”€â”€ MAIN 3-COLUMN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="war-main">
    <!-- LEFT: FIELD AGENTS -->
    <div class="glass gpu-accel" id="panel-agents">
      <div class="glass-ca-overlay"></div>
      <div class="glass-light"></div>
      <div class="glass-header">
        <span class="glass-title">Field Agents</span>
        <span class="glass-badge" id="agent-count">0</span>
      </div>
      <div class="glass-body" id="services-list">
        <div class="feed-empty">Awaiting intelâ€¦</div>
      </div>
    </div>

    <!-- CENTER: LIVE FEED -->
    <div class="glass gpu-accel" id="panel-feed">
      <div class="glass-ca-overlay"></div>
      <div class="glass-light"></div>
      <div class="glass-header">
        <span class="glass-title">Live Feed â€” All Channels</span>
        <span class="glass-badge" id="feed-count">0</span>
      </div>
      <div class="glass-body" id="feed-list">
        <div class="feed-empty">Monitoring all frequenciesâ€¦</div>
      </div>
    </div>

    <!-- RIGHT: NEURAL STATUS -->
    <div class="glass gpu-accel" id="panel-neural">
      <div class="glass-ca-overlay"></div>
      <div class="glass-light"></div>
      <div class="glass-header">
        <span class="glass-title">System &amp; Neural Status</span>
      </div>
      <div class="glass-body" id="neural-panel">
        <div class="feed-empty">Connecting to neuralâ€¦</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ COMMAND BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="cmd-bar">
    <span class="cmd-prompt">&gt;</span>
    <input type="text" class="cmd-input" id="cmd-input" placeholder="Directive for Theiaâ€¦" autocomplete="off" />
    <button class="cmd-send" id="cmd-send">Send</button>
    <span class="cmd-chain"><b>CINC</b> Henry â€º <b>SECDEF</b> Theia â€º Field Agents</span>
  </div>
</div>

<div class="watermark">THEIA AI SYSTEMS</div>

<!-- â”€â”€ LOG MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="log-modal">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title" id="log-modal-title">Logs</span>
      <button class="modal-close" onclick="closeLogModal()">Close</button>
    </div>
    <div class="modal-body" id="log-modal-body"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHROMATIC ABERRATION GLASS SYSTEM
   From Henry's GlassSurface.tsx â€” converted to vanilla JS
   SVG displacement maps with per-channel R/G/B offsets
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GlassSystem = {
  panels: [],
  filterDefs: document.querySelector('.svg-filters defs'),
  counter: 0,

  // Dark mode parameters from Henry's component
  config: {
    backgroundOpacity: 0,
    blur: 16,
    brightness: 8,
    opacity: 0.75,
    saturation: 1.2,
    distortionScale: -180,
    borderWidth: 0.07,
    borderRadius: 20,
    mixBlendMode: 'difference',
    redOffset: 0,
    greenOffset: 10,
    blueOffset: 20,
    xChannel: 'R',
    yChannel: 'G',
  },

  generateDisplacementSVG(width, height, id) {
    const c = this.config;
    const edgeSize = Math.min(width, height) * (c.borderWidth * 0.5);
    return `<svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="rg-${id}" x1="100%" y1="0%" x2="0%" y2="0%">
          <stop offset="0%" stop-color="#0000"/>
          <stop offset="100%" stop-color="red"/>
        </linearGradient>
        <linearGradient id="bg-${id}" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#0000"/>
          <stop offset="100%" stop-color="blue"/>
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="${width}" height="${height}" fill="black"/>
      <rect x="0" y="0" width="${width}" height="${height}" rx="${c.borderRadius}" fill="url(#rg-${id})"/>
      <rect x="0" y="0" width="${width}" height="${height}" rx="${c.borderRadius}" fill="url(#bg-${id})" style="mix-blend-mode:${c.mixBlendMode}"/>
      <rect x="${edgeSize}" y="${edgeSize}" width="${width - edgeSize * 2}" height="${height - edgeSize * 2}" rx="${c.borderRadius}" fill="hsl(0 0% ${c.brightness}% / ${c.opacity})" style="filter:blur(${c.blur}px)"/>
    </svg>`;
  },

  createFilter(id) {
    const c = this.config;
    const filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
    filter.setAttribute('id', `glass-ca-${id}`);
    filter.setAttribute('colorInterpolationFilters', 'sRGB');
    filter.setAttribute('x', '0%');
    filter.setAttribute('y', '0%');
    filter.setAttribute('width', '100%');
    filter.setAttribute('height', '100%');

    filter.innerHTML = `
      <feImage x="0" y="0" width="100%" height="100%" preserveAspectRatio="none" result="map" data-feimage="true"/>
      <feDisplacementMap in="SourceGraphic" in2="map" xChannelSelector="${c.xChannel}" yChannelSelector="${c.yChannel}" scale="${c.distortionScale + c.redOffset}" result="dispRed"/>
      <feColorMatrix in="dispRed" type="matrix" values="1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0" result="red"/>
      <feDisplacementMap in="SourceGraphic" in2="map" xChannelSelector="${c.xChannel}" yChannelSelector="${c.yChannel}" scale="${c.distortionScale + c.greenOffset}" result="dispGreen"/>
      <feColorMatrix in="dispGreen" type="matrix" values="0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0" result="green"/>
      <feDisplacementMap in="SourceGraphic" in2="map" xChannelSelector="${c.xChannel}" yChannelSelector="${c.yChannel}" scale="${c.distortionScale + c.blueOffset}" result="dispBlue"/>
      <feColorMatrix in="dispBlue" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0" result="blue"/>
      <feBlend in="red" in2="green" mode="screen" result="rg"/>
      <feBlend in="rg" in2="blue" mode="screen" result="output"/>
      <feGaussianBlur in="output" stdDeviation="0.7"/>
    `;

    this.filterDefs.appendChild(filter);
    return filter;
  },

  updateFilterImage(filter, width, height, id) {
    const svgContent = this.generateDisplacementSVG(width, height, id);
    const dataUri = 'data:image/svg+xml,' + encodeURIComponent(svgContent);
    const feImage = filter.querySelector('[data-feimage]');
    if (feImage) feImage.setAttribute('href', dataUri);
  },

  init() {
    document.querySelectorAll('.glass').forEach(panel => {
      const id = this.counter++;
      const filter = this.createFilter(id);
      const overlay = panel.querySelector('.glass-ca-overlay');

      if (overlay) {
        overlay.style.filter = `url(#glass-ca-${id})`;
        // Fill overlay so filter has something to process
        overlay.style.background = `rgba(0,0,0,${this.config.backgroundOpacity})`;
      }

      const updateSize = () => {
        const rect = panel.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          this.updateFilterImage(filter, rect.width, rect.height, id);
        }
      };

      // ResizeObserver to regenerate displacement map on resize
      const ro = new ResizeObserver(() => setTimeout(updateSize, 0));
      ro.observe(panel);
      setTimeout(updateSize, 100);

      this.panels.push({ panel, filter, id, overlay, ro });
    });
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURSOR-TRACKING LIGHT SPOTS
   From Henry's liquid-glass.tsx â€” mousemove radial gradient
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.glass').forEach(panel => {
  const light = panel.querySelector('.glass-light');
  if (!light) return;
  panel.addEventListener('mousemove', (e) => {
    const rect = panel.getBoundingClientRect();
    light.style.left = (e.clientX - rect.left) + 'px';
    light.style.top = (e.clientY - rect.top) + 'px';
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEBGL BACKGROUND â€” Noise Nebula with Crimson Veins
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function initBackground() {
  const canvas = document.getElementById('bg-canvas');
  const renderer = new THREE.WebGLRenderer({ canvas, alpha: false, antialias: false });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);

  const scene = new THREE.Scene();
  const camera = new THREE.OrthographicCamera(-1,1,1,-1,0,1);

  const fragmentShader = `
    uniform float u_time;
    uniform vec2 u_resolution;

    vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}
    vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}
    vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}
    vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}
    float snoise(vec3 v){
      const vec2 C=vec2(1.0/6.0,1.0/3.0);
      const vec4 D=vec4(0.0,0.5,1.0,2.0);
      vec3 i=floor(v+dot(v,C.yyy));
      vec3 x0=v-i+dot(i,C.xxx);
      vec3 g=step(x0.yzx,x0.xyz);
      vec3 l=1.0-g;
      vec3 i1=min(g.xyz,l.zxy);
      vec3 i2=max(g.xyz,l.zxy);
      vec3 x1=x0-i1+C.xxx;
      vec3 x2=x0-i2+C.yyy;
      vec3 x3=x0-D.yyy;
      i=mod289(i);
      vec4 p=permute(permute(permute(
        i.z+vec4(0.0,i1.z,i2.z,1.0))
        +i.y+vec4(0.0,i1.y,i2.y,1.0))
        +i.x+vec4(0.0,i1.x,i2.x,1.0));
      float n_=0.142857142857;
      vec3 ns=n_*D.wyz-D.xzx;
      vec4 j=p-49.0*floor(p*ns.z*ns.z);
      vec4 x_=floor(j*ns.z);
      vec4 y_=floor(j-7.0*x_);
      vec4 x=x_*ns.x+ns.yyyy;
      vec4 y=y_*ns.x+ns.yyyy;
      vec4 h=1.0-abs(x)-abs(y);
      vec4 b0=vec4(x.xy,y.xy);
      vec4 b1=vec4(x.zw,y.zw);
      vec4 s0=floor(b0)*2.0+1.0;
      vec4 s1=floor(b1)*2.0+1.0;
      vec4 sh=-step(h,vec4(0.0));
      vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;
      vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;
      vec3 p0=vec3(a0.xy,h.x);
      vec3 p1=vec3(a0.zw,h.y);
      vec3 p2=vec3(a1.xy,h.z);
      vec3 p3=vec3(a1.zw,h.w);
      vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));
      p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;
      vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);
      m=m*m;
      return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));
    }

    void main(){
      vec2 uv=gl_FragCoord.xy/u_resolution.xy;
      float t=u_time*0.12;

      // Layered noise
      float n1=snoise(vec3(uv*2.0,t))*0.5+0.5;
      float n2=snoise(vec3(uv*4.5+3.0,t*1.2))*0.5+0.5;
      float n3=snoise(vec3(uv*9.0+7.0,t*0.6))*0.5+0.5;
      float combined=n1*0.5+n2*0.3+n3*0.2;

      // Deep void
      vec3 color=vec3(0.018,0.018,0.026);

      // Dark nebula
      color+=vec3(0.025,0.012,0.018)*smoothstep(0.3,0.7,n1);

      // Crimson veins
      float veins=smoothstep(0.47,0.53,combined);
      float pulse=sin(t*2.5)*0.3+0.7;
      color+=vec3(0.76,0.07,0.11)*veins*0.05*pulse;

      // Subtle ember highlights
      float highlight=smoothstep(0.55,0.8,n2);
      color+=vec3(0.06,0.02,0.015)*highlight*0.4;

      // Deep blue undertone
      color+=vec3(0.005,0.008,0.02)*smoothstep(0.2,0.6,n3);

      // Vignette
      float vig=1.0-smoothstep(0.2,1.2,length((uv-0.5)*1.5));
      color*=0.65+vig*0.35;

      gl_FragColor=vec4(color,1.0);
    }
  `;

  const material = new THREE.ShaderMaterial({
    uniforms: {
      u_time: { value: 0 },
      u_resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) }
    },
    vertexShader: `void main(){gl_Position=vec4(position,1.0);}`,
    fragmentShader
  });

  const mesh = new THREE.Mesh(new THREE.PlaneGeometry(2,2), material);
  scene.add(mesh);

  window.addEventListener('resize', () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
    material.uniforms.u_resolution.value.set(window.innerWidth, window.innerHeight);
  });

  const startTime = Date.now();
  (function animate() {
    material.uniforms.u_time.value = (Date.now() - startTime) * 0.001;
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  })();
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLE FIELD â€” Floating Embers (Crimson/Amber)
   Inspired by starship 400k particles, scaled to 8000 for 2D
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function initParticles() {
  const canvas = document.getElementById('particle-canvas');
  const ctx = canvas.getContext('2d');
  const PARTICLE_COUNT = 6000;
  let W, H;
  const particles = [];

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  for (let i = 0; i < PARTICLE_COUNT; i++) {
    const depth = Math.random();
    particles.push({
      x: Math.random() * W,
      y: Math.random() * H,
      vx: (Math.random() - 0.5) * 0.15,
      vy: -Math.random() * 0.3 - 0.05,
      size: 0.4 + depth * 1.2,
      alpha: 0.08 + depth * 0.2,
      hue: Math.random() < 0.7 ? (0 + Math.random() * 15) : (25 + Math.random() * 15), // crimson or amber
      depth
    });
  }

  function draw() {
    ctx.clearRect(0, 0, W, H);
    for (const p of particles) {
      p.x += p.vx;
      p.y += p.vy;

      // Wrap
      if (p.y < -5) { p.y = H + 5; p.x = Math.random() * W; }
      if (p.x < -5) p.x = W + 5;
      if (p.x > W + 5) p.x = -5;

      // Flicker
      const flicker = 0.7 + Math.sin(Date.now() * 0.001 * (p.depth + 0.5) + p.x * 0.01) * 0.3;

      ctx.globalAlpha = p.alpha * flicker;
      ctx.fillStyle = `hsl(${p.hue}, 80%, ${45 + p.depth * 25}%)`;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GSAP ENTRANCE ANIMATIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
gsap.set('#app', { opacity: 0 });
gsap.to('#app', { opacity: 1, duration: 1, ease: 'power2.out', delay: 0.15 });

gsap.from('.nav-bar', { y: -20, opacity: 0, duration: 0.7, ease: 'power3.out', delay: 0.3 });
gsap.to('#brand-line', { width: 48, duration: 1.2, ease: 'power2.out', delay: 0.8 });

gsap.from('#panel-agents', { x: -30, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.5 });
gsap.from('#panel-feed',   { y: 20, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.65 });
gsap.from('#panel-neural',  { x: 30, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.8 });
gsap.from('.cmd-bar', { y: 20, opacity: 0, duration: 0.7, ease: 'power3.out', delay: 0.9 });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE & WEBSOCKET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const state = {
  services: [], system: {}, neural: {}, brain: {}, recall: {},
  cloudBrain: {}, cloudRecent: [], feed: [], connected: false
};
const MAX_FEED = 200;
let feedCount = 0;

let ws, reconnTimer;
function connect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/dashboard/ws`);
  ws.onopen = () => { state.connected = true; renderConn(); };
  ws.onclose = () => { state.connected = false; renderConn(); reconnTimer = setTimeout(connect, 3000); };
  ws.onerror = () => ws.close();
  ws.onmessage = (ev) => {
    try {
      const { type, data } = JSON.parse(ev.data);
      switch (type) {
        case 'services':
          state.services = data.services || [];
          state.system = data.system || {};
          renderServices();
          renderNeural();
          break;
        case 'neural': state.neural = data; renderNeural(); break;
        case 'brain': state.brain = data; renderNeural(); break;
        case 'recall': state.recall = data; renderNeural(); break;
        case 'cloud-brain': state.cloudBrain = data; renderNeural(); break;
        case 'cloud-recent': state.cloudRecent = Array.isArray(data) ? data : []; break;
        case 'feed': addFeed(data); break;
        case 'command-ack':
          addFeed({ channel: 'dashboard', speaker: 'system', text: 'âœ“ Command dispatched', ts: Date.now() });
          break;
      }
    } catch {}
  };
}

function sendCommand(text) {
  if (!text.trim() || !ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type: 'command', text: text.trim() }));
  addFeed({ channel: 'dashboard', speaker: 'Henry', text: text.trim(), ts: Date.now() });
  document.getElementById('cmd-input').value = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDERERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function renderConn() {
  const dot = document.getElementById('conn-dot');
  const label = document.getElementById('conn-label');
  if (state.connected) {
    dot.className = 'conn-dot ok'; label.textContent = 'Online';
  } else {
    dot.className = 'conn-dot err'; label.textContent = 'Offline';
  }
}

function renderServices() {
  const el = document.getElementById('services-list');
  const svcs = state.services;
  document.getElementById('agent-count').textContent = svcs.length;
  if (!svcs.length) { el.innerHTML = '<div class="feed-empty">No agents detected</div>'; return; }

  const newHTML = svcs.map(s => {
    const mem = s.memory ? (s.memory / 1048576).toFixed(0) + 'MB' : 'â€”';
    const cpu = s.cpu !== undefined ? s.cpu + '%' : 'â€”';
    const up = s.uptime ? timeSince(s.uptime) : 'â€”';
    return `<div class="svc-item" onclick="viewLogs('${esc(s.name)}')">
      <span class="svc-dot ${s.status}"></span>
      <span class="svc-name">${esc(s.name)}</span>
      <span class="svc-meta">
        <span class="svc-meta-line">${cpu} Â· ${mem}</span>
        <span class="svc-meta-line">â†‘${up} Â· â†»${s.restarts}</span>
      </span>
    </div>`;
  }).join('');

  if (el.innerHTML.includes('feed-empty') || el.dataset.hash !== hashStr(newHTML)) {
    el.innerHTML = newHTML;
    el.dataset.hash = hashStr(newHTML);
  }
}

function renderNeural() {
  const el = document.getElementById('neural-panel');
  const n = state.neural || {};
  const b = state.brain || {};
  const r = state.recall || {};
  const sys = state.system || {};
  const cb = state.cloudBrain || {};

  const cpuPct = sys.cpuPercent ?? 0;
  const memPct = sys.memUsedPercent ?? 0;
  const cpuCls = cpuPct > 90 ? 'crit' : cpuPct > 70 ? 'warn' : 'ok';
  const memCls = memPct > 90 ? 'crit' : memPct > 70 ? 'warn' : 'ok';

  let html = '';

  html += `<div class="stat-section">
    <div class="stat-section-title">System</div>
    <div class="stat-row"><span class="stat-label">CPU</span><span class="stat-value ${cpuCls}">${cpuPct}%<span class="progress-wrap"><span class="progress-fill ${cpuCls}" style="width:${cpuPct}%"></span></span></span></div>
    <div class="stat-row"><span class="stat-label">Memory</span><span class="stat-value ${memCls}">${memPct}%<span class="progress-wrap"><span class="progress-fill ${memCls}" style="width:${memPct}%"></span></span></span></div>
    ${statRow('Free', sys.memFree ? fmtBytes(sys.memFree) : 'â€”')}
    ${statRow('Uptime', sys.uptime ? fmtUptime(sys.uptime) : 'â€”')}
    ${statRow('Load', sys.loadAvg ? sys.loadAvg.map(l => l.toFixed(1)).join(' / ') : 'â€”')}
  </div>`;

  html += `<div class="stat-section">
    <div class="stat-section-title">Neural Cloud</div>
    ${statRow('Events', fmtNum(cb.total_events || cb.events_count || 'â€”'))}
    ${statRow('Embeddings', fmtNum(cb.total_embeddings || cb.embeddings_count || 'â€”'))}
    ${statRow('Edges', fmtNum(cb.total_edges || cb.edges_count || 'â€”'))}
    ${statRow('User Facts', fmtNum(cb.total_user_facts || cb.user_facts_count || 'â€”'))}
    ${statRow('Working Set', fmtNum(cb.working_set_count || 'â€”'))}
  </div>`;

  html += `<div class="stat-section">
    <div class="stat-section-title">Brain State</div>
    ${statRow('Emotion', b.current_emotion ?? 'â€”')}
    ${statRow('Topic', b.active_topic ?? 'â€”')}
    ${statRow('Channel', b.last_interaction?.channel ?? 'â€”')}
  </div>`;

  html += `<div class="stat-section">
    <div class="stat-section-title">Neural Signal</div>
    ${statRow('Connections', n.connections_active ?? n.connections_total ?? 'â€”')}
    ${statRow('Cache Hits', fmtNum(n.cache_hits ?? 'â€”'))}
    ${statRow('Latency', n.avg_latency_ms !== undefined ? n.avg_latency_ms + 'ms' : 'â€”')}
  </div>`;

  html += `<div class="stat-section">
    <div class="stat-section-title">Total Recall</div>
    ${statRow('Messages', fmtNum(r.total_messages ?? 'â€”'))}
    ${statRow('Pending', r.pending_embedding ?? 'â€”')}
    ${statRow('Rate/hr', r.storage_rate_per_hour ?? 'â€”')}
  </div>`;

  el.innerHTML = html;
}

function statRow(label, value) {
  return `<div class="stat-row"><span class="stat-label">${label}</span><span class="stat-value">${value}</span></div>`;
}

/* â”€â”€ Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function addFeed(msg) {
  if (!msg) return;
  if (!msg.text && msg.content) msg.text = msg.content;
  if (!msg.speaker && msg.role) msg.speaker = msg.role === 'user' ? 'henry' : 'theia';
  state.feed.push(msg);
  if (state.feed.length > MAX_FEED) state.feed.shift();
  feedCount++;
  document.getElementById('feed-count').textContent = feedCount;
  renderFeedItem(msg);
}

function renderFeedItem(msg) {
  const el = document.getElementById('feed-list');
  const empty = el.querySelector('.feed-empty');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = 'feed-msg';

  const ts = msg.ts || msg.timestamp;
  const d = ts ? new Date(ts) : null;
  const time = (d && !isNaN(d.getTime()))
    ? d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit' }) : '';

  const channel = (msg.channel || 'system').toLowerCase().replace(/\s+/g, '-');
  const speaker = msg.speaker || msg.from || 'system';
  const spkClass = speaker.toLowerCase().includes('henry') ? 'henry'
    : speaker.toLowerCase().includes('theia') ? 'theia' : 'other';

  const icons = { imessage:'ğŸ', discord:'ğŸ®', telegram:'âœˆï¸', webchat:'ğŸŒ', 'dashboard':'âš”ï¸' };
  const icon = icons[channel] || 'ğŸ“¡';

  div.innerHTML = `
    <span class="feed-time">${time}</span>
    <span class="feed-icon">${icon}</span>
    <span class="feed-speaker ${spkClass}">${esc(speaker)}</span>
    <span class="feed-text">${esc(msg.text || '')}</span>
  `;
  el.appendChild(div);
  while (el.children.length > MAX_FEED) el.removeChild(el.firstChild);
  el.scrollTop = el.scrollHeight;
}

/* â”€â”€ Log Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function viewLogs(name) {
  const modal = document.getElementById('log-modal');
  document.getElementById('log-modal-title').textContent = `Logs â€” ${name}`;
  document.getElementById('log-modal-body').textContent = 'Fetching logsâ€¦';
  modal.classList.add('open');
  fetch(`/logs/${name}`).then(r => r.ok ? r.text() : 'Unavailable').then(t => {
    document.getElementById('log-modal-body').textContent = t || 'No logs';
  }).catch(() => {
    document.getElementById('log-modal-body').textContent = 'Unable to fetch logs';
  });
}
function closeLogModal() { document.getElementById('log-modal').classList.remove('open'); }
document.getElementById('log-modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('log-modal')) closeLogModal();
});

/* â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function fmtBytes(b) {
  if (b > 1073741824) return (b / 1073741824).toFixed(1) + ' GB';
  if (b > 1048576) return (b / 1048576).toFixed(0) + ' MB';
  return (b / 1024).toFixed(0) + ' KB';
}
function fmtUptime(s) {
  const d = Math.floor(s / 86400), h = Math.floor((s % 86400) / 3600), m = Math.floor((s % 3600) / 60);
  return d ? `${d}d ${h}h` : h ? `${h}h ${m}m` : `${m}m`;
}
function fmtNum(v) {
  if (v === 'â€”' || v === undefined || v === null) return 'â€”';
  const n = Number(v);
  if (isNaN(n)) return String(v);
  return n.toLocaleString();
}
function timeSince(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s / 60) + 'm';
  if (s < 86400) return Math.floor(s / 3600) + 'h';
  return Math.floor(s / 86400) + 'd';
}
function hashStr(s) { let h = 0; for (let i = 0; i < s.length; i++) h = ((h << 5) - h) + s.charCodeAt(i) | 0; return h; }

/* â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateClock() {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'UTC' }) + ' UTC';
}
setInterval(updateClock, 1000);
updateClock();

/* â”€â”€ Command Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('cmd-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendCommand(e.target.value);
});
document.getElementById('cmd-send').addEventListener('click', () => {
  sendCommand(document.getElementById('cmd-input').value);
});

/* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
GlassSystem.init();
connect();
</script>
</body>
</html>
